import{d as te,u as ae,r as h,A as Ie,B as A,C as xe,D as Te,c as $,b as a,f as l,F as Ue,w as s,k as $e,G as Fe,H as C,I,q as De,J as ze,K as Be,v as y,g as Ve,o as u,L as Pe,s as p,M as w,l as le,m as b,N as Ne,y as Le,O as Re,P as Me,Q as Ae,R as Ke,S as je,T as He,U as Oe,V as se,W as qe,X as Ge,Y as Je,Z as Qe,$ as Ye,a0 as We,a1 as Xe,x as oe,a2 as Ze,E as et,h as tt,a3 as at}from"./index-Cq-zLFLx.js";/* empty css                    *//* empty css                        *//* empty css                *//* empty css                 */import{_ as lt}from"./cute-5sQKAEaQ.js";import{u as st,f as E}from"./uploadTask-BwJ3XCiZ.js";const ot={class:"file-explorer"},nt={class:"file-actions"},it={class:"left-actions"},rt={class:"wiggle"},dt={class:"wiggle"},ut={class:"right-actions"},ct={class:"search-and-buttons"},pt={class:"buttons-group"},ft={class:"card-header"},vt={class:"header-left"},_t={class:"card-title"},mt={key:0,class:"search-result-text"},gt={key:0,class:"header-right"},yt={class:"directory-path"},wt={key:0,class:"cute-loading-container"},ht={class:"file-name-cell"},bt=["onClick"],kt={class:"file-operations"},St={class:"pagination-container"},Ct={class:"chunk-upload-container"},Et={key:0,class:"selected-file-info"},It={class:"file-info-row"},xt={class:"file-value"},Tt={class:"file-info-row"},Ut={class:"file-value"},$t={class:"file-info-row"},Ft={class:"file-value"},Dt={class:"upload-controls"},zt=te({__name:"FileExplorer",props:{type:{type:String,required:!0,validator:F=>["my-files","public-files"].includes(F)},title:{type:String,default:"文件"}},emits:["update:loading"],setup(F,{expose:T,emit:D}){const z=F,c=D,N=ae(),K=st(),f=Ve(),r=h({id:0,name:"根目录"}),x=h([]),d=h(!1),_=h(1),k=h(10),L=h(0),U=h(""),V=h(!1),j=Ie(()=>z.type==="my-files"),H=h(null),P=h(!1),S=h(null),O=t=>{if(t.state&&t.state.directoryId!==void 0){const e=t.state;r.value={id:e.directoryId,name:e.directoryName||"根目录"},m()}};A(()=>{window.addEventListener("popstate",O),window.history.state||window.history.replaceState({directoryId:0,directoryName:"根目录"},"",window.location.pathname)}),xe(()=>{window.removeEventListener("popstate",O)}),Te(()=>z.type,t=>{console.log("文件浏览器类型改变:",t),q(),setTimeout(()=>{m()},50)});const q=()=>{r.value={id:0,name:"根目录"},_.value=1,V.value=!1,U.value="",window.history.replaceState({directoryId:0,directoryName:"根目录"},"",window.location.pathname)},m=async()=>{x.value=[],d.value=!0,c("update:loading",!0);try{let t;V.value&&U.value?t=await E.searchFiles(U.value,_.value,k.value):z.type==="my-files"?t=await E.getUserFiles(r.value.id,_.value,k.value):t=await E.getPublicFiles(_.value,k.value),console.log("加载文件响应:",t),t?(x.value=t.files||[],L.value=t.total||0):(x.value=[],L.value=0,y.warning("未获取到文件数据"))}catch(t){console.error("加载文件失败:",t),y.error("加载文件失败，请稍后重试"),x.value=[],L.value=0}finally{d.value=!1,c("update:loading",!1)}},G=async t=>{try{if(t.isDir){J(t);return}d.value=!0,c("update:loading",!0);const e=await E.downloadFileDirectly(t.id),n=window.URL.createObjectURL(e),i=document.createElement("a");i.href=n,i.setAttribute("download",t.filename),document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),window.URL.revokeObjectURL(n)},100),y.success("文件下载开始")}catch(e){console.error("文件下载失败:",e),y.error("文件下载失败，请稍后重试")}finally{d.value=!1,c("update:loading",!1)}},J=t=>{window.history.pushState({directoryId:t.id,directoryName:t.filename},"",window.location.pathname),r.value={id:t.id,name:t.filename},_.value=1,m()},Q=async()=>{if(r.value.id!==0)try{d.value=!0,c("update:loading",!0);const t=await E.getFileInfo(r.value.id);if(t&&t.file){const e=t.file.parentId||0;let n="根目录";if(e!==0){const i=await E.getFileInfo(e);i&&i.file&&(n=i.file.filename)}window.history.pushState({directoryId:e,directoryName:n},"",window.location.pathname),r.value={id:e,name:n},_.value=1,m()}else window.history.pushState({directoryId:0,directoryName:"根目录"},"",window.location.pathname),r.value={id:0,name:"根目录"},_.value=1,m(),y.warning("获取文件夹信息失败，已返回根目录")}catch(t){console.error("导航失败:",t),y.error("导航失败，已返回根目录"),window.history.pushState({directoryId:0,directoryName:"根目录"},"",window.location.pathname),r.value={id:0,name:"根目录"},_.value=1,m()}finally{d.value=!1,c("update:loading",!1)}},ne=async t=>{try{await Xe.confirm(`确定要删除${t.isDir?"文件夹":"文件"} "${t.filename}" 吗？`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),d.value=!0,c("update:loading",!0),await E.deleteFile(t.id),y.success(`${t.isDir?"文件夹":"文件"}删除成功`),m()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),y.error("删除失败"))}finally{d.value=!1,c("update:loading",!1)}},ie=async t=>{try{d.value=!0;const e=t.visibility!=="public";t.isDir?(await E.updateFolderPublicStatus(t.id,e),y.success("文件夹及其子文件公开状态已更新")):(await E.updateFilePublicStatus(t.id,e),y.success("文件公开状态已更新")),t.visibility=e?"public":"private"}catch(e){console.error("更新公开状态失败",e),y.error("更新公开状态失败")}finally{d.value=!1}},Y=()=>{U.value.trim()?(V.value=!0,_.value=1,m()):(V.value=!1,m())},re=t=>{k.value=t,m()},de=t=>{_.value=t,m()},W=t=>{const e=["B","KB","MB","GB","TB"];let n=0,i=t;for(;i>=1024&&n<e.length-1;)i/=1024,n++;let v=0;return n===1?v=1:n>=2&&(v=2),i.toFixed(v).replace(/\.0+$/,"")+" "+e[n]},ue=t=>{if(!t)return"";const e=new Date(t),n=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),v=String(e.getDate()).padStart(2,"0"),g=String(e.getHours()).padStart(2,"0"),R=String(e.getMinutes()).padStart(2,"0");return`${n}-${i}-${v} ${g}:${R}`},ce=()=>{var t;(t=H.value)==null||t.click()},pe=async t=>{const e=t.target;if(!(!e.files||e.files.length===0)){d.value=!0,c("update:loading",!0);try{const n=Array.from(e.files),i=[];for(const v of n){const g=v.webkitRelativePath;i.push(g)}await E.uploadFolder(n,i,r.value.id,!1),y.success("文件夹上传成功"),m()}catch(n){console.error("文件夹上传失败",n),y.error(`文件夹上传失败: ${n.message||"未知错误"}`)}finally{d.value=!1,c("update:loading",!1),e&&(e.value="")}}},fe=t=>{S.value=t.raw},ve=()=>{X(),P.value=!1},_e=async()=>{S.value&&(K.addTask(S.value,r.value.id,!1),y.success("已添加到上传任务列表"),P.value=!1,X(),f.push("/upload-tasks"))},X=()=>{S.value=null},me=()=>{f.push("/upload-tasks")};return A(()=>{m()}),T({loadFiles:m,resetState:q}),(t,e)=>{const n=Pe,i=Ue,v=le,g=De,R=$e,ge=Le("List"),ye=Ke,B=He,we=Ge,he=Je,be=Qe,ke=ze,Se=Ye,Ce=Be,Ee=je;return u(),$("div",ot,[a("div",nt,[a("div",it,[l(i,{separator:"/"},{default:s(()=>[l(n,{to:{path:"/"}},{default:s(()=>e[5]||(e[5]=[a("i",{class:"el-icon-house"},null,-1),p(" 首页 ")])),_:1,__:[5]}),l(n,null,{default:s(()=>[a("span",rt,w(F.title),1)]),_:1}),r.value.id!==0?(u(),C(n,{key:0,onClick:Q,class:"clickable-breadcrumb"},{default:s(()=>[a("span",dt,w(r.value.name),1)]),_:1})):I("",!0)]),_:1})]),a("div",ut,[a("div",ct,[l(R,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=o=>U.value=o),placeholder:"搜索文件",class:"search-input",onKeyup:Fe(Y,["enter"])},{append:s(()=>[l(g,{onClick:Y},{default:s(()=>[l(v,null,{default:s(()=>[l(b(Ne))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a("div",pt,[l(g,{type:"info",onClick:me,class:"action-button wiggle"},{default:s(()=>[l(v,null,{default:s(()=>[l(ge)]),_:1}),e[6]||(e[6]=p(" 上传任务列表 "))]),_:1,__:[6]}),j.value?(u(),C(g,{key:0,type:"primary",onClick:e[1]||(e[1]=o=>P.value=!0),class:"action-button wiggle"},{default:s(()=>[l(v,null,{default:s(()=>[l(b(Re))]),_:1}),e[7]||(e[7]=p(" 上传文件 "))]),_:1,__:[7]})):I("",!0),j.value?(u(),C(g,{key:1,type:"warning",onClick:ce,class:"action-button wiggle"},{default:s(()=>[l(v,null,{default:s(()=>[l(b(Me))]),_:1}),e[8]||(e[8]=p(" 上传文件夹 "))]),_:1,__:[8]})):I("",!0)])]),a("input",{ref_key:"folderInput",ref:H,type:"file",onChange:pe,webkitdirectory:"",directory:"",multiple:"",style:{display:"none"}},null,544)])]),l(ke,{class:"file-list-card"},{header:s(()=>[a("div",ft,[a("div",vt,[a("span",_t,w(F.title),1),V.value?(u(),$("span",mt,"搜索结果: "+w(U.value),1)):I("",!0)]),r.value.id!==0?(u(),$("div",gt,[a("span",yt,[p(" 当前目录: "+w(r.value.name)+" ",1),l(g,{size:"small",onClick:Q,type:"text",class:"wiggle"},{default:s(()=>e[9]||(e[9]=[p(" 返回上级 ")])),_:1,__:[9]})])])):I("",!0)])]),default:s(()=>[d.value?(u(),$("div",wt,e[10]||(e[10]=[a("div",{class:"cute-loading"},null,-1),a("div",{class:"loading-text"},"加载中...",-1)]))):x.value.length===0?(u(),C(ye,{key:1,description:"暂无文件",class:"empty-files"},{default:s(()=>e[11]||(e[11]=[a("img",{src:lt,class:"empty-image floating",alt:"暂无文件"},null,-1)])),_:1,__:[11]})):Ae((u(),C(he,{key:2,data:x.value,style:{width:"100%"}},{default:s(()=>[l(B,{label:"文件名",prop:"filename","min-width":"200"},{default:s(o=>[a("div",ht,[o.row.isDir?(u(),C(v,{key:0,class:"file-icon folder-icon"},{default:s(()=>[l(b(Oe))]),_:1})):(u(),C(v,{key:1,class:"file-icon"},{default:s(()=>[l(b(se))]),_:1})),a("span",{class:qe({"folder-name":o.row.isDir}),onClick:M=>o.row.isDir?J(o.row):G(o.row)},w(o.row.filename),11,bt)])]),_:1}),l(B,{label:"大小",prop:"fileSize",width:"100"},{default:s(o=>[p(w(o.row.isDir?"-":W(o.row.fileSize)),1)]),_:1}),l(B,{label:"所有者",prop:"ownerName",width:"100"}),l(B,{label:"上传时间",prop:"createTime",width:"160"},{default:s(o=>[p(w(ue(o.row.createTime)),1)]),_:1}),l(B,{label:"状态",prop:"visibility",width:"80"},{default:s(o=>[l(we,{type:o.row.visibility==="public"?"success":"info",class:"status-tag no-after"},{default:s(()=>[p(w(o.row.visibility==="public"?"公开":"私有"),1)]),_:2},1032,["type"])]),_:1}),l(B,{label:"操作",width:"180",fixed:"right"},{default:s(o=>{var M,Z;return[a("div",kt,[o.row.isDir?I("",!0):(u(),C(g,{key:0,size:"small",onClick:ee=>G(o.row),class:"action-btn wiggle"},{default:s(()=>e[12]||(e[12]=[p(" 下载 ")])),_:2,__:[12]},1032,["onClick"])),o.row.userId===((M=b(N).userInfo)==null?void 0:M.id)?(u(),C(g,{key:1,size:"small",type:"danger",onClick:ee=>ne(o.row),class:"action-btn wiggle"},{default:s(()=>e[13]||(e[13]=[p(" 删除 ")])),_:2,__:[13]},1032,["onClick"])):I("",!0),o.row.userId===((Z=b(N).userInfo)==null?void 0:Z.id)?(u(),C(g,{key:2,size:"small",type:"info",onClick:ee=>ie(o.row),class:"action-btn wiggle visibility-btn"},{default:s(()=>[p(w(o.row.visibility==="public"?"设为私有":"设为公开"),1)]),_:2},1032,["onClick"])):I("",!0)])]}),_:1})]),_:1},8,["data"])),[[Ee,d.value]]),a("div",St,[l(be,{"current-page":_.value,"onUpdate:currentPage":e[2]||(e[2]=o=>_.value=o),"page-size":k.value,"onUpdate:pageSize":e[3]||(e[3]=o=>k.value=o),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:L.value,onSizeChange:re,onCurrentChange:de},null,8,["current-page","page-size","total"])])]),_:1}),l(Ce,{modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=o=>P.value=o),title:"文件上传",width:"500px"},{default:s(()=>[a("div",Ct,[l(Se,{class:"chunk-upload",drag:"",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":fe},{default:s(()=>[l(v,{class:"el-icon--upload"},{default:s(()=>[l(b(We))]),_:1}),e[14]||(e[14]=a("div",{class:"el-upload__text"},[p(" 拖拽文件到此处或 "),a("em",null,"点击选择")],-1))]),_:1,__:[14]}),S.value?(u(),$("div",Et,[a("div",It,[e[15]||(e[15]=a("span",{class:"file-label"},"文件名:",-1)),a("span",xt,w(S.value.name),1)]),a("div",Tt,[e[16]||(e[16]=a("span",{class:"file-label"},"大小:",-1)),a("span",Ut,w(W(S.value.size)),1)]),a("div",$t,[e[17]||(e[17]=a("span",{class:"file-label"},"类型:",-1)),a("span",Ft,w(S.value.type||"未知"),1)])])):I("",!0),a("div",Dt,[l(g,{type:"primary",onClick:_e,disabled:!S.value,class:"wiggle"},{default:s(()=>e[18]||(e[18]=[p(" 开始上传 ")])),_:1,__:[18]},8,["disabled"]),l(g,{type:"danger",onClick:ve,disabled:!S.value,class:"wiggle"},{default:s(()=>e[19]||(e[19]=[p(" 取消 ")])),_:1,__:[19]},8,["disabled"])])])]),_:1},8,["modelValue"])])}}}),Bt=oe(zt,[["__scopeId","data-v-f89ce272"]]),Vt={class:"home-container"},Pt={class:"page-header"},Nt={key:0,class:"user-greeting"},Lt={class:"greeting-text"},Rt={class:"avatar-container"},Mt={class:"tabs-container"},At={class:"tab-label"},Kt={class:"tab-label"},jt=te({__name:"HomeView",setup(F){const T=ae(),D=h("my-files"),z=h(!1),c=h(null),N=()=>{c.value&&(c.value.resetState(),setTimeout(()=>{c.value&&c.value.loadFiles()},50))};return A(()=>{T.token||T.init()}),(K,f)=>{const r=Ze,x=le,d=tt,_=et;return u(),$("div",Vt,[a("div",Pt,[f[2]||(f[2]=a("div",{class:"title-container"},[a("h1",{class:"main-title"},[p("ByteVault "),a("span",{class:"subtitle"},"文件管理系统")])],-1)),b(T).userInfo?(u(),$("div",Nt,[a("span",Lt,"欢迎回来，"+w(b(T).userInfo.username)+" !",1),a("div",Rt,[l(r,{src:b(T).userInfo.avatarUrl||"https://i.imgur.com/Jvh1OQm.jpg"},null,8,["src"])])])):I("",!0)]),a("div",Mt,[l(_,{modelValue:D.value,"onUpdate:modelValue":f[0]||(f[0]=k=>D.value=k),onTabClick:N,class:"custom-tabs"},{default:s(()=>[l(d,{label:"我的文件",name:"my-files"},{label:s(()=>[a("div",At,[l(x,null,{default:s(()=>[l(b(se))]),_:1}),f[3]||(f[3]=a("span",null,"我的文件",-1))])]),_:1}),l(d,{label:"公共文件",name:"public-files"},{label:s(()=>[a("div",Kt,[l(x,null,{default:s(()=>[l(b(at))]),_:1}),f[4]||(f[4]=a("span",null,"公共文件",-1))])]),_:1})]),_:1},8,["modelValue"])]),l(Bt,{type:D.value,title:D.value==="my-files"?"我的文件":"公共文件",loading:z.value,"onUpdate:loading":f[1]||(f[1]=k=>z.value=k),ref_key:"fileExplorer",ref:c},null,8,["type","title","loading"]),f[5]||(f[5]=a("div",{class:"footer-decoration"},null,-1))])}}}),Wt=oe(jt,[["__scopeId","data-v-04e87880"]]);export{Wt as default};
